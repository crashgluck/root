{% extends 'base/base.html' %}
{% load static %}
{% block content %}

<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-6">
      {% for d in page_obj  %}
      <div class="card mb-5 post mx-auto" style="width: 18rem;">
        <div class="card-header">
          <h3 class="card-text">{{ d.titulo }}</h3>
        </div>
        <img src="{{ d.imagen.url }}" class="card-img-top" alt="Imagen del post">
        <div class="card-body">
          <p class="card-text">{{ d.contenido }}</p>

          <!-- Formulario para manejar favoritos -->
          <form action="{% url 'toggle_favorito' d.id %}" method="post" class="mb-2">
            {% csrf_token %}
            {% if user.is_authenticated %}
              {% if d.id in liked_posts %}
                <button class="btn btn-warning btn-sm" type="submit">
                  ‚òÖ Quitar de favoritos ({{ d.total_favoritos }})
                </button>
              {% else %}
                <button class="btn btn-outline-warning btn-sm" type="submit">
                  ‚òÜ Agregar a favoritos ({{ d.total_favoritos }})
                </button>
              {% endif %}
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-outline-secondary btn-sm">Inicia sesi√≥n para agregar a favoritos</a>
            {% endif %}
          </form>

          
          <!-- Formulario para manejar likes -->
          <form action="{% url 'like_post' d.id %}" method="post" class="mb-2">
            {% csrf_token %}
            {% if user.is_authenticated %}
              {% if d.id in liked_posts %}
                <button class="btn btn-danger btn-sm" type="submit">
                  ‚ù§Ô∏è Quitar Like ({{ d.total_likes }})
                </button>
              {% else %}
                <button class="btn btn-outline-danger btn-sm" type="submit">
                  ü§ç Dar Like ({{ d.total_likes }})
                </button>
              {% endif %}
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-outline-secondary btn-sm">Inicia sesi√≥n para dar like</a>
            {% endif %}
          </form>

          <div class="mb-2">
            <a href="{% url 'comentar_post' d.id %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-chat-dots"> Ver y comentar</i></a>
          </div>

          

          
          

          

        </div>
      </div>
      {% endfor %}
      <!-- Paginaci√≥n -->
<div class="d-flex justify-content-center mt-4">
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Anterior</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
      {% endif %}
    </ul>
  </nav>
</div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $('.toggle-aprobado').on('click', function () {
      const button = $(this);
      const postId = button.data('id');

      $.ajax({
        url: "{% url 'toggle_aprobado' %}",
        type: "POST",
        data: {
          post_id: postId,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            const estado = response.aprobado ? "S√≠" : "No";
            button.closest('.post').find('.estado').text(estado);
            button.text(response.aprobado ? "Desaprobar" : "Aprobar");
          } else {
            alert(response.error || "Algo sali√≥ mal.");
          }
        },
        error: function () {
          alert("Error en la solicitud.");
        }
      });
    });
  });
</script>
{% endblock %}
